<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Leaflet Map with Numbered Markers</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body { height: 100%; margin: 0; font-family: sans-serif; }
#map { height: 100%; width: 100%; }

/* Top Drawer */
#drawer {
  position: fixed;
  top: -300px;
  left: 0;
  width: 100%;
  background: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  z-index: 1001;
  transition: top 0.3s ease;
  padding: 14px;
  box-sizing: border-box;
}
#drawer.open { top: 0; }

#drawer input[type="text"] {
  width: 100%;
  padding: 14px;
  font-size: 20px;
  font-weight: bold;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
  margin-bottom: 12px;
}

#drawer .buttonRow { display: flex; gap: 12px; flex-wrap: wrap; }
#drawer .buttonRow button {
  flex: 1;
  padding: 12px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #ccc;
  cursor: pointer;
  background: white;
}

.checkboxRow {
  display: flex;
  align-items: center;
  margin-top: 12px;
  gap: 40px;
  font-size: 14px;
  color: #333;
  cursor: pointer;
}
.checkboxRow input[type="checkbox"] { width: auto; margin: 0; }

/* Drawer toggle button */
#toggleDrawerBtn {
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1002;
  background: #007bff;
  border: none;
  cursor: pointer;
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
#toggleDrawerBtn::before {
  content: '';
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 14px solid white;
  transition: transform 0.3s ease;
}
#toggleDrawerBtn.arrow-up::before { transform: rotate(180deg); }

/* Bottom position bar */
#positionBar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(255,255,255,0.3);
  font-size: 22px;
  font-weight: bold;
  text-align: center;
  padding: 6px 0;
  z-index: 1002;
  color: #000;
  pointer-events: none;
}

/* Fullscreen button */
#fullscreenBtn {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 1002;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  width: 60px;
  height: 60px;
  font-size: 28px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}

.marker-label {
  background: transparent;
  border: none;
  color: black;
  font-weight: bold;
  font-size: 14px;
  text-shadow: 1px 1px 2px white;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="drawer">
  <input type="text" id="coordsInput" placeholder="lat, lon">
  <div class="buttonRow">
    <button id="addMarkerBtn">Add Marker</button>
    <button id="clearMarkersBtn">Clear All Markers</button>
    <button id="resetCounterBtn">Reset Numbering</button>
    <input type="file" id="fileInput" accept=".txt,.csv" />
  </div>

  <div class="checkboxRow">
    <label><input type="checkbox" id="keepOpenCheckbox"> Keep open after adding</label>
    <label><input type="checkbox" id="freezeMapCheckbox"> Freeze map</label>
  </div>
</div>

<button id="toggleDrawerBtn" aria-label="Toggle Drawer"></button>
<button id="fullscreenBtn">⛶</button>
<div id="positionBar">Waiting for GPS…</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>
<script>
const map = L.map('map').setView([54.971793, -2.949397], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors | © KC 2025'
}).addTo(map);

// Drawer toggle
const drawer = document.getElementById('drawer');
const toggleBtn = document.getElementById('toggleDrawerBtn');
function updateToggleButton() {
  const isOpen = drawer.classList.contains('open');
  toggleBtn.classList.toggle('arrow-up', isOpen);
  toggleBtn.style.top = isOpen ? `${drawer.offsetHeight}px` : '0px';
}
toggleBtn.addEventListener('click', () => { drawer.classList.toggle('open'); updateToggleButton(); });
window.addEventListener('resize', updateToggleButton);
document.addEventListener('DOMContentLoaded', () => { setTimeout(updateToggleButton, 100); });

// Fullscreen button
const fullscreenBtn = document.getElementById('fullscreenBtn');
fullscreenBtn.onclick = () => {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err=>console.warn(err));
  else document.exitFullscreen();
};

// GPS + red arrow marker
let currentMarker = null;
const posBar = document.getElementById('positionBar');
let lastLat = null, lastLon = null, lastTime = null;
let currentAngle = 0;
let freezeMap = false;

document.getElementById('freezeMapCheckbox').addEventListener('change', e => {
  freezeMap = e.target.checked;
});

function createArrowIcon() {
  return L.divIcon({
    className: '',
    html: `<svg width="24" height="24" viewBox="0 0 24 24">
      <polygon points="12,0 24,24 12,18 0,24" fill="red"/>
    </svg>`,
    iconSize: [24,24],
    iconAnchor: [12,12]
  });
}
function lerp(a,b,t){ return a+(b-a)*t; }
function lerpAngle(a,b,t){ const diff=((b-a+540)%360)-180; return a+diff*t; }

navigator.geolocation.watchPosition(
  pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const now = pos.timestamp;
    const heading = pos.coords.heading !== null ? pos.coords.heading : currentAngle;

    // Speed
    let speedText = '';
    if(lastLat!==null && lastLon!==null && lastTime!==null){
      const distance = map.distance([lastLat,lastLon],[lat,lon]);
      const timeDiff = (now-lastTime)/1000;
      const speedMps = distance/timeDiff;
      const speedMph = speedMps*2.23694;
      if(speedMph>3) speedText=` | Speed: ${speedMph.toFixed(1)} mph`;
    }
    lastLat=lat; lastLon=lon; lastTime=now;

    posBar.textContent=`Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}${speedText}`;

    if(!freezeMap){
      if(!currentMarker){
        currentMarker=L.marker([lat,lon],{icon:createArrowIcon(),rotationAngle:heading}).addTo(map);
        currentAngle=heading;
        map.setView([lat,lon],16);
      } else {
        const latLng=currentMarker.getLatLng();
        const newLat=lerp(latLng.lat,lat,0.2);
        const newLng=lerp(latLng.lng,lon,0.2);
        currentMarker.setLatLng([newLat,newLng]);
        currentAngle=lerpAngle(currentAngle,heading,0.2);
        currentMarker.setRotationAngle(currentAngle);
      }
    }
  },
  err=>console.warn(err),
  { enableHighAccuracy:true }
);

// --- Numbered Markers with Persistence ---
let markerCount = parseInt(localStorage.getItem('markerCount')) || 0;
let storedMarkers = JSON.parse(localStorage.getItem('markers')||'[]');
const userMarkers = [];

function saveMarkers() {
  const data = userMarkers.map(m=>{
    const pos=m.getLatLng();
    return {id:m.options.markerId,lat:pos.lat,lng:pos.lng};
  });
  localStorage.setItem('markers',JSON.stringify(data));
  localStorage.setItem('markerCount',markerCount);
}

function addNumberedMarker(lat,lon,id=null) {
  if(!id){ markerCount++; id=markerCount; }
  const m=L.marker([lat,lon],{draggable:true,autoPan:true,markerId:id})
    .addTo(map)
    .bindPopup(`Marker #${id}<br>Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`)
    .openPopup();
  m.bindTooltip(`${id}`,{permanent:true,direction:'center',className:'marker-label'});
  m.on('dragend',()=>{ const pos=m.getLatLng(); m.setPopupContent(`Marker #${id}<br>Lat: ${pos.lat.toFixed(5)}, Lon: ${pos.lng.toFixed(5)}`); saveMarkers(); });
  userMarkers.push(m); saveMarkers(); return m;
}

// Restore stored markers
storedMarkers.forEach(sm=>{ addNumberedMarker(sm.lat,sm.lng,sm.id); });

// Buttons
document.getElementById('addMarkerBtn').addEventListener('click',()=>{
  const input=document.getElementById('coordsInput').value.trim();
  if(!input.includes(',')) return alert('Enter coordinates as lat, lon');
  const parts=input.split(',').map(p=>parseFloat(p.trim()));
  if(parts.length!==2||parts.some(isNaN)) return alert('Invalid numbers');
  const [lat,lon]=parts;
  addNumberedMarker(lat,lon);
  map.panTo([lat,lon]);
  document.getElementById('coordsInput').value='';
  if(!document.getElementById('keepOpenCheckbox').checked){ drawer.classList.remove('open'); updateToggleButton(); }
});

document.getElementById('clearMarkersBtn').addEventListener('click',()=>{
  userMarkers.forEach(m=>map.removeLayer(m));
  userMarkers.length=0;
  markerCount=0;
  localStorage.setItem('markerCount',0);
  localStorage.setItem('markers','[]');
});

document.getElementById('resetCounterBtn').addEventListener('click',()=>{
  if(confirm("Reset numbering back to 0? New markers will start at #1 (old markers keep their numbers).")){
    markerCount=0; localStorage.setItem('markerCount',0);
  }
});

// Double click to add marker
map.on('dblclick',e=>{ const {lat,lng}=e.latlng; addNumberedMarker(lat,lng); });

// File import
document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=evt=>{
    const lines=evt.target.result.split(/\r?\n/).filter(l=>l.trim().length);
    lines.forEach(line=>{
      const parts=line.split(',').map(p=>p.trim());
      if(parts.length>=3){
        const lat=parseFloat(parts[1]); const lon=parseFloat(parts[2]);
        if(!isNaN(lat)&&!isNaN(lon)) addNumberedMarker(lat,lon);
      }
    });
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
